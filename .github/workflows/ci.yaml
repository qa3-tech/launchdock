name: Launchdock CI/CD

on:
  push:
    branches: [main]
    tags: ["[0-9]+.[0-9]+.[0-9]+"]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.89.0
        with:
          components: rustfmt, clippy

      - name: Cache cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests
        run: cargo test --verbose

  build-linux:
    name: Build Linux x86_64
    if: startsWith(github.ref, 'refs/tags/')
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Update version in Cargo.toml
        run: sed -i "s|0.0.0|${{ steps.version.outputs.VERSION }}|" Cargo.toml

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Cache cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ubuntu-x86_64-unknown-linux-gnu-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxkbcommon-dev libwayland-dev libxrandr-dev libxcursor-dev libxi-dev libxinerama-dev libgl1-mesa-dev

      - name: Build release binary
        run: cargo build --release --target x86_64-unknown-linux-gnu

      - name: Get binary name
        id: binary_name
        run: |
          BINARY_NAME=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].targets[] | select(.kind[] == "bin") | .name' | head -1)
          echo "BINARY_NAME=$BINARY_NAME" >> $GITHUB_OUTPUT

      - name: Package binary
        run: |
          cd target/x86_64-unknown-linux-gnu/release
          cp ../../../LICENSE .
          cp ../../../INSTALL .
          tar -czf ../../../launchdock-linux-x86_64.tar.gz ${{ steps.binary_name.outputs.BINARY_NAME }} LICENSE INSTALL
          cd -

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: launchdock-linux-x86_64.tar.gz
          path: launchdock-linux-x86_64.tar.gz

  build-macos-intel:
    name: Build macOS Intel
    if: startsWith(github.ref, 'refs/tags/')
    needs: test
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Update version in files
        run: sed -i '' "s|0.0.0|${{ steps.version.outputs.VERSION }}|" Info.plist Cargo.toml

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: Cache cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: macos-x86_64-apple-darwin-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binary
        run: cargo build --release --target x86_64-apple-darwin

      - name: Get binary name
        id: binary_name
        run: |
          BINARY_NAME=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].targets[] | select(.kind[] == "bin") | .name' | head -1)
          echo "BINARY_NAME=$BINARY_NAME" >> $GITHUB_OUTPUT

      - name: Create app bundle
        run: |
          mkdir -p LaunchDock.app/Contents/MacOS
          mkdir -p LaunchDock.app/Contents/Resources
          cp target/x86_64-apple-darwin/release/${{ steps.binary_name.outputs.BINARY_NAME }} LaunchDock.app/Contents/MacOS/
          cp launch.sh LaunchDock.app/Contents/MacOS/
          chmod +x LaunchDock.app/Contents/MacOS/launch.sh
          cp Info.plist LaunchDock.app/Contents/
          cp LICENSE LaunchDock.app/Contents/Resources/
          cp INSTALL LaunchDock.app/Contents/Resources/

      - name: Create DMG
        run: |
          hdiutil create -volname "LaunchDock" \
            -srcfolder LaunchDock.app \
            -ov -format UDZO \
            LaunchDock-${{ steps.version.outputs.VERSION }}-intel.dmg

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: LaunchDock-${{ steps.version.outputs.VERSION }}-intel.dmg
          path: LaunchDock-${{ steps.version.outputs.VERSION }}-intel.dmg

  build-macos-arm:
    name: Build macOS Apple Silicon
    if: startsWith(github.ref, 'refs/tags/')
    needs: test
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Update version in files
        run: sed -i '' "s|0.0.0|${{ steps.version.outputs.VERSION }}|" Info.plist Cargo.toml

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Cache cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: macos-aarch64-apple-darwin-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binary
        run: cargo build --release --target aarch64-apple-darwin

      - name: Get binary name
        id: binary_name
        run: |
          BINARY_NAME=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].targets[] | select(.kind[] == "bin") | .name' | head -1)
          echo "BINARY_NAME=$BINARY_NAME" >> $GITHUB_OUTPUT

      - name: Create app bundle
        run: |
          mkdir -p LaunchDock.app/Contents/MacOS
          mkdir -p LaunchDock.app/Contents/Resources
          cp target/aarch64-apple-darwin/release/${{ steps.binary_name.outputs.BINARY_NAME }} LaunchDock.app/Contents/MacOS/
          cp launch.sh LaunchDock.app/Contents/MacOS/
          chmod +x LaunchDock.app/Contents/MacOS/launch.sh
          cp Info.plist LaunchDock.app/Contents/
          cp LICENSE LaunchDock.app/Contents/Resources/
          cp INSTALL LaunchDock.app/Contents/Resources/

      - name: Create DMG
        run: |
          hdiutil create -volname "LaunchDock" \
            -srcfolder LaunchDock.app \
            -ov -format UDZO \
            LaunchDock-${{ steps.version.outputs.VERSION }}-arm64.dmg

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: LaunchDock-${{ steps.version.outputs.VERSION }}-arm64.dmg
          path: LaunchDock-${{ steps.version.outputs.VERSION }}-arm64.dmg

  # build-windows-x86:
  #   name: Build Windows x86_64
  #   if: startsWith(github.ref, 'refs/tags/')
  #   needs: test
  #   runs-on: windows-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #
  #     - name: Install Rust
  #       uses: dtolnay/rust-toolchain@stable
  #       with:
  #         targets: x86_64-pc-windows-msvc
  #
  #     - name: Cache cargo dependencies
  #       uses: actions/cache@v4
  #       with:
  #         path: |
  #           ~/.cargo/registry
  #           ~/.cargo/git
  #           target
  #         key: windows-x86_64-pc-windows-msvc-cargo-${{ hashFiles('**/Cargo.lock') }}
  #
  #     - name: Build release binary
  #       run: cargo build --release --target x86_64-pc-windows-msvc
  #
  #     - name: Get binary name
  #       id: binary_name
  #       run: |
  #         $BINARY_NAME = (cargo metadata --no-deps --format-version 1 | ConvertFrom-Json).packages[0].targets | Where-Object { $_.kind -contains "bin" } | Select-Object -First 1 -ExpandProperty name
  #         echo "BINARY_NAME=$BINARY_NAME" >> $env:GITHUB_OUTPUT
  #
  #     - name: Package binary
  #       run: |
  #         cd target/x86_64-pc-windows-msvc/release
  #         cp ../../../LICENSE .
  #         cp ../../../INSTALL .
  #         7z a ../../../launchdock-windows-x86_64.zip ${{ steps.binary_name.outputs.BINARY_NAME }}.exe LICENSE INSTALL
  #         cd -
  #
  #     - name: Upload artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: launchdock-windows-x86_64.zip
  #         path: launchdock-windows-x86_64.zip

  release:
    name: Create GitHub Release
    if: startsWith(github.ref, 'refs/tags/')
    needs: [test, build-linux, build-macos-intel, build-macos-arm]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Get tag name
        id: tag
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" -o -name "*.dmg" \) -exec cp {} release-assets/ \;
          ls -la release-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.TAG_NAME }}
          name: "LaunchDock v${{ steps.tag.outputs.TAG_NAME }}"
          body: |
            ## LaunchDock v${{ steps.tag.outputs.TAG_NAME }}

            Download the appropriate binary for your platform below.

            **macOS:**
            - `.dmg` files for easy installation (drag to Applications folder)
            - `intel` for Intel Macs, `arm64` for Apple Silicon

            **Linux:**
            - `.tar.gz` archive with binary and documentation

            Each archive contains:
            - The LaunchDock binary (or app bundle for macOS)
            - INSTALL file with setup instructions
            - LICENSE file with dual licensing terms

            See the INSTALL file in the archive for complete setup instructions.
          files: release-assets/*
          draft: true
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
